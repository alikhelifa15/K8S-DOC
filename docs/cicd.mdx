# Pipeline CI/CD FitConnect - Version Actuelle ğŸ”„

Pipeline GitLab CI simplifiÃ© pour automatiser les builds et dÃ©ploiements sur Google Kubernetes Engine.

## ğŸ¯ Vue d'Ensemble du Pipeline

### Architecture CI/CD Actuelle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ”¨ BUILD  â”‚â”€â”€â”€â–¶â”‚  ğŸ§ª TEST   â”‚â”€â”€â”€â–¶â”‚ ğŸš€ DEPLOY  â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ Frontend    â”‚    â”‚ Unit Tests  â”‚    â”‚ K8s Deploy  â”‚
â”‚ API Build   â”‚    â”‚ Frontend    â”‚    â”‚ All        â”‚
â”‚ Docker      â”‚    â”‚ API Tests   â”‚    â”‚ Services   â”‚
â”‚ Push GCR    â”‚    â”‚ PostgreSQL  â”‚    â”‚ Production â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Stages Actuels

| Stage | Composants | Runner | Branche |
|-------|------------|--------|---------|
| **ğŸ”¨ Build** | Frontend + API | ilyes-runner | feature-deploy-ilyes |
| **ğŸ§ª Test** | Frontend + API | ilyes-runner | main |
| **ğŸš€ Deploy** | Production K8s | ilyes-runner | feature-deploy-ilyes |

## ğŸ“‹ Configuration GitLab CI

### Variables d'Environnement

```yaml
variables:
  DOCKER_DRIVER: overlay2
  GCP_PROJECT_ID: "k8s-frist-test"
  GKE_CLUSTER_NAME: "react-app-cluster"
  GKE_ZONE: "europe-west1-b"
  AR_LOCATION: "europe-west1"
  AR_REPO: "annual-project-repo"
  NAMESPACE: "annual-project"
```

### Stages Configuration

```yaml
stages:
  - build
  - test
  - deploy
```

## ğŸ”¨ Stage: Build

### Build Frontend

```yaml
build-frontend:
  stage: build
  image: google/cloud-sdk:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""  
  before_script:
    - apt-get update && apt-get install -y docker.io
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud auth configure-docker ${AR_LOCATION}-docker.pkg.dev
  script:
    - cd client
    - IMAGE_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:${CI_COMMIT_SHA}"
    - docker build -t $IMAGE_URL .
    - docker push $IMAGE_URL
    - LATEST_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:latest"
    - docker tag $IMAGE_URL $LATEST_URL
    - docker push $LATEST_URL
  tags:
    - ilyes-runner  
  only:
    - feature-deploy-ilyes
```

### Build API

```yaml
build-api:
  stage: build
  image: google/cloud-sdk:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apt-get update && apt-get install -y docker.io
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud auth configure-docker ${AR_LOCATION}-docker.pkg.dev
  script:
    - cd server
    - IMAGE_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:${CI_COMMIT_SHA}"
    - docker build -t $IMAGE_URL .
    - docker push $IMAGE_URL
    - LATEST_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:latest"
    - docker tag $IMAGE_URL $LATEST_URL
    - docker push $LATEST_URL
  tags:
    - ilyes-runner  
  only:
    - feature-deploy-ilyes
```

## ğŸ§ª Stage: Test

### Tests Frontend

```yaml
test-frontend:
  stage: test
  image: node:18-alpine
  cache:
    paths:
      - client/node_modules/
  before_script:
    - cd client
  script:
    - npm ci
    - npm run test
  tags:
    - ilyes-runner  
  only:
    - main
```

### Tests API

```yaml
test-api:
  stage: test
  image: node:18-alpine
  services:
    - postgres:14
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_HOST: postgres
    DATABASE_PORT: 5432
    DATABASE_USER: postgres
    DATABASE_PASSWORD: postgres
    DATABASE_NAME: test_db
  cache:
    paths:
      - server/node_modules/
  before_script:
    - cd server
  script:
    - npm ci
    - npm run test
  tags:
    - ilyes-runner  
  only:
    - main
```

## ğŸš€ Stage: Deploy

### DÃ©ploiement Production

```yaml
deploy:
  stage: deploy
  image: google/cloud-sdk:alpine
  before_script:
    - gcloud components install kubectl --quiet
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE
  script:
    # Nettoyage des ressources obsolÃ¨tes
    - kubectl delete ingress keycloak-ingress -n annual-project || true
    
    # Application des ressources de base
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/network-policy/

    # ğŸ” Configuration des certificats HTTPS
    - echo "ğŸ” Applying ManagedCertificate fitnessconnect-cert..."
    - kubectl apply -f k8s/ingress/fitnessconnect-cert.yaml

    # ğŸ” VÃ©rification du certificat
    - echo "ğŸ” Verifying ManagedCertificate fitnessconnect-cert status..."
    - kubectl describe managedcertificate fitnessconnect-cert -n $NAMESPACE || echo "âš ï¸ Certificat peut prendre quelques minutes"

    # Configuration Ingress
    - kubectl apply -f k8s/ingress/

    # ğŸ—„ï¸ DÃ©ploiement PostgreSQL
    - echo "Deploying PostgreSQL..."
    - kubectl apply -f k8s/postgres/
    - kubectl wait --for=condition=available --timeout=300s deployment/postgres -n $NAMESPACE
    
    # ğŸ”‘ DÃ©ploiement Keycloak
    - echo "Deploying Keycloak..."
    - kubectl apply -f k8s/keycloak/keycloak-secret.yaml
    - kubectl apply -f k8s/keycloak/keycloak-service.yaml
    
    # Configuration du thÃ¨me Keycloak
    - echo "ğŸ“‚ Listing theme folder contents:"
    - ls -R k8s/keycloak/themes/mytheme
    - echo "ğŸ“¦ Creating Keycloak theme ConfigMap..."
    - kubectl create configmap keycloak-theme --from-file=k8s/keycloak/themes/mytheme --namespace=annual-project --dry-run=client -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/keycloak/keycloak-all.yaml

    # ğŸ“Š Services de monitoring
    - echo "Deploying Adminer..."
    - kubectl apply -f k8s/adminer/
    - echo "Deploying Uptime Kuma..."
    - kubectl apply -f k8s/uptime-kuma/

    # ğŸ”„ Mise Ã  jour des images applicatives
    - FRONTEND_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:${CI_COMMIT_SHA}"
    - API_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:${CI_COMMIT_SHA}"
    - sed -i "s|image europe-west1-docker.pkg.dev/.*/frontend:.*|image ${FRONTEND_IMAGE}|g" k8s/frontend/frontend-all.yaml
    - sed -i "s|image europe-west1-docker.pkg.dev/.*/api:.*|image $API_IMAGE|g" k8s/api/api-all.yaml

    # âš™ï¸ DÃ©ploiement API
    - echo "Deploying API..."
    - kubectl apply -f k8s/api/
    - kubectl wait --for=condition=available --timeout=300s deployment/api -n $NAMESPACE

    # ğŸ–¥ï¸ DÃ©ploiement Frontend
    - echo "Deploying Frontend..."
    - kubectl apply -f k8s/frontend/
    - kubectl wait --for=condition=available --timeout=300s deployment/frontend -n $NAMESPACE

    # â³ Attendre Keycloak
    - echo "Waiting for Keycloak to be ready..."
    - kubectl wait --for=condition=available --timeout=600s deployment/keycloak -n $NAMESPACE || echo "Keycloak may take longer to start"
  tags:
    - ilyes-runner
  only:
    - feature-deploy-ilyes
```

## ğŸ”§ Configuration Actuelle

### Runner Configuration

- **Runner utilisÃ©** : `ilyes-runner`
- **Type** : Runner personnalisÃ© avec Docker socket
- **Configuration Docker** : Socket Unix direct (`unix:///var/run/docker.sock`)

### StratÃ©gie de Branche

| OpÃ©ration | Branche | DÃ©clenchement |
|-----------|---------|---------------|
| **Build** | `feature-deploy-ilyes` | Push automatique |
| **Test** | `main` | Push automatique |
| **Deploy** | `feature-deploy-ilyes` | Push automatique |

### Images Docker

```
Format des tags:
- SHA commit : {AR_LOCATION}-docker.pkg.dev/{PROJECT_ID}/{REPO}/{SERVICE}:{CI_COMMIT_SHA}
- Latest : {AR_LOCATION}-docker.pkg.dev/{PROJECT_ID}/{REPO}/{SERVICE}:latest

Exemples:
- europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/frontend:abc123
- europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/api:abc123
```

## ğŸ“¦ Services DÃ©ployÃ©s

### Services Principaux

| Service | Type | Namespace | Description |
|---------|------|-----------|-------------|
| **Frontend** | React App | annual-project | Interface utilisateur |
| **API** | Node.js | annual-project | Backend REST API |
| **PostgreSQL** | Database | annual-project | Base de donnÃ©es principale |
| **Keycloak** | Auth | annual-project | Authentification SSO |

### Services Auxiliaires

| Service | Type | Description |
|---------|------|-------------|
| **Adminer** | DB Admin | Interface d'administration PostgreSQL |
| **Uptime Kuma** | Monitoring | Surveillance des services |

## ğŸŒ Configuration RÃ©seau

### Ingress et Certificats

```yaml
# Certificat SSL managÃ© par Google Cloud
ManagedCertificate: fitnessconnect-cert

# Ingress routing
- Frontend: https://fitnessconnect.fr
- API: https://api.fitnessconnect.fr  
- Keycloak: https://login.fitnessconnect.fr
- Adminer: https://adminer.fitnessconnect.fr
- Uptime: https://uptimekuma.fitnessconnect.fr
```

### Network Policies

```yaml
# SÃ©curitÃ© rÃ©seau au niveau du namespace
- Isolation du trafic inter-pods
- RÃ¨gles de communication dÃ©finies
- Protection contre les accÃ¨s non autorisÃ©s
```

## ğŸ”„ Flux de DÃ©ploiement

### Ordre des DÃ©ploiements

```
1. ğŸ§¹ Nettoyage (ingress obsolÃ¨tes)
2. ğŸ“‹ Namespace et policies
3. ğŸ” Certificats SSL
4. ğŸŒ Configuration Ingress  
5. ğŸ—„ï¸ PostgreSQL
6. ğŸ”‘ Keycloak + thÃ¨me custom
7. ğŸ“Š Services monitoring
8. ğŸ”„ Mise Ã  jour images
9. âš™ï¸ DÃ©ploiement API
10. ğŸ–¥ï¸ DÃ©ploiement Frontend
11. â³ Attente Keycloak ready
```

### Variables InjectÃ©es

```bash
# Images construites dynamiquement
FRONTEND_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:${CI_COMMIT_SHA}"
API_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:${CI_COMMIT_SHA}"

# Replacement dans les manifests K8s
sed -i "s|image europe-west1-docker.pkg.dev/.*/frontend:.*|image ${FRONTEND_IMAGE}|g" k8s/frontend/frontend-all.yaml
sed -i "s|image europe-west1-docker.pkg.dev/.*/api:.*|image $API_IMAGE|g" k8s/api/api-all.yaml
```

## ğŸ¯ Points ClÃ©s de la Configuration

### Avantages

âœ… **Pipeline simple** : 3 stages clairs et efficaces  
âœ… **Runner dÃ©diÃ©** : Performance garantie avec `ilyes-runner`  
âœ… **Images taggÃ©es** : SHA commit + latest pour traÃ§abilitÃ©  
âœ… **DÃ©ploiement complet** : Tous les services en une fois  
âœ… **Certificats SSL** : HTTPS managÃ© par Google Cloud  
âœ… **Monitoring intÃ©grÃ©** : Uptime Kuma + Adminer  

### SpÃ©cificitÃ©s Techniques

ğŸ”§ **Docker Socket** : AccÃ¨s direct via Unix socket  
ğŸ”§ **GCP Integration** : Authentification par service account  
ğŸ”§ **K8s Manifests** : Modification dynamique des images  
ğŸ”§ **Keycloak Theme** : ConfigMap depuis fichiers locaux  
ğŸ”§ **Attente dÃ©ploiements** : `kubectl wait` pour synchronisation  

---

> **âš¡ Configuration Production** : Cette pipeline est optimisÃ©e pour votre environnement spÃ©cifique avec le runner `ilyes-runner` et dÃ©ploie directement sur la branche `feature-deploy-ilyes`.

> **ğŸ”’ SÃ©curisÃ©** : Utilisation de service accounts GCP et secrets GitLab CI pour les credentials sensibles.