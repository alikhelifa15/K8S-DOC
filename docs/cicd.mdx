# ğŸš€ Pipeline CI/CD FitConnect - Documentation Officielle

Pipeline GitLab CI/CD moderne avec gestion des branches GitFlow et dÃ©ploiement automatisÃ© sur Google Kubernetes Engine.

## ğŸ¯ Vue d'Ensemble du Pipeline

### Architecture CI/CD Nouvelle Version

```
Feature Branches / Develop          Main Branch
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ§ª TEST ONLY       â”‚    â”‚ ğŸ—ï¸ BUILD + ğŸš€ DEPLOY   |
â”‚                         â”‚    â”‚                         â”‚
â”‚ âœ“ Frontend Unit Tests   â”‚    â”‚ âœ“ Docker Build Frontend â”‚
â”‚ âœ“ API Unit Tests        â”‚    â”‚ âœ“ Docker Build API      â”‚
â”‚ âœ“ PostgreSQL Tests      â”‚    â”‚ âœ“ Push to Registry      â”‚
â”‚                         â”‚    â”‚ âœ“ Deploy to Production  â”‚
â”‚                         â”‚    â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                         â”‚
                               â”‚                         â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### StratÃ©gie de Branche GitFlow

| Type de Branche | Tests | Build | Deploy | Description |
|------------------|-------|-------|--------|-------------|
| **feature/** | âœ… | âŒ | âŒ | Tests automatiques uniquement |
| **develop** | âœ… | âŒ | âŒ | Tests + intÃ©gration continue |
| **main** | âŒ | âœ… | âœ… | Build + Deploy                  |

## ğŸ“‹ Configuration GitLab CI

### Variables d'Environnement Globales

```yaml
variables:
  # ğŸ³ Configuration Docker
  DOCKER_DRIVER: overlay2
  
  # â˜ï¸ Configuration GCP
  GCP_PROJECT_ID: "k8s-frist-test"
  GKE_CLUSTER_NAME: "react-app-cluster"
  GKE_ZONE: "europe-west1-b"
  
  # ğŸ“¦ Configuration Artifact Registry
  AR_LOCATION: "europe-west1"
  AR_REPO: "annual-project-repo"
  
  # ğŸ  Configuration Kubernetes
  NAMESPACE: "annual-project"
```

### Stages Configuration

```yaml
stages:
  - ğŸ§ª test      # Tests unitaires (feature/develop uniquement)
  - ğŸ—ï¸ build     # Construction des images Docker (main uniquement)
  - ğŸš€ deploy    # DÃ©ploiement sur GKE (main uniquement)
```

## ğŸ§ª Stage: Tests

### Tests Frontend

**DÃ©clenchement** : Feature branches, develop, MR vers develop

```yaml
ğŸ§ª test-frontend:
  stage: ğŸ§ª test
  image: node:18-alpine
  cache:
    paths:
      - client/node_modules/
  before_script:
    - cd client
  script:
    - npm ci
    - npm run test
  tags:
    - ilyes-runner
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"
```

### Tests API avec PostgreSQL

**DÃ©clenchement** : Feature branches, develop, MR vers develop

```yaml
ğŸ§ª test-api:
  stage: ğŸ§ª test
  image: node:18-alpine
  services:
    - postgres:14
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_HOST: postgres
    DATABASE_PORT: 5432
    DATABASE_USER: postgres
    DATABASE_PASSWORD: postgres
    DATABASE_NAME: test_db
  cache:
    paths:
      - server/node_modules/
  before_script:
    - cd server
  script:
    - npm ci
    - npm run test
  tags:
    - ilyes-runner
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop"
```

## ğŸ—ï¸ Stage: Build

### Build Frontend

**DÃ©clenchement** : Branche main uniquement

```yaml
ğŸ—ï¸ build-frontend:
  stage: ğŸ—ï¸ build
  image: google/cloud-sdk:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""  
  before_script:
    - apt-get update && apt-get install -y docker.io
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud auth configure-docker ${AR_LOCATION}-docker.pkg.dev
  script:
    - cd client
    - IMAGE_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:${CI_COMMIT_SHA}"
    - LATEST_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:latest"
    - docker build -t $IMAGE_URL .
    - docker push $IMAGE_URL
    - docker tag $IMAGE_URL $LATEST_URL
    - docker push $LATEST_URL
  tags:
    - ilyes-runner  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
```

### Build API

**DÃ©clenchement** : Branche main uniquement

```yaml
ğŸ—ï¸ build-api:
  stage: ğŸ—ï¸ build
  image: google/cloud-sdk:latest
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apt-get update && apt-get install -y docker.io
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud auth configure-docker ${AR_LOCATION}-docker.pkg.dev
  script:
    - cd server
    - IMAGE_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:${CI_COMMIT_SHA}"
    - LATEST_URL="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:latest"
    - docker build -t $IMAGE_URL .
    - docker push $IMAGE_URL
    - docker tag $IMAGE_URL $LATEST_URL
    - docker push $LATEST_URL
  tags:
    - ilyes-runner  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
```

## ğŸš€ Stage: Deploy

### DÃ©ploiement Production Complet

**DÃ©clenchement** : Branche main uniquement  
**DÃ©pendances** : NÃ©cessite build-frontend ET build-api

```yaml
ğŸš€ deploy:
  stage: ğŸš€ deploy
  image: google/cloud-sdk:alpine
  before_script:
    - gcloud components install kubectl --quiet
    - echo $GCP_SERVICE_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE
  script:
    # ğŸ§¹ Nettoyage des ressources obsolÃ¨tes
    - kubectl delete ingress keycloak-ingress -n annual-project || true
    
    # ğŸ—ï¸ Infrastructure de base
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/network-policy/

    # ğŸ” Configuration HTTPS
    - kubectl apply -f k8s/ingress/fitnessconnect-cert.yaml
    - kubectl describe managedcertificate fitnessconnect-cert -n $NAMESPACE || echo "âš ï¸ Certificat en cours de provisioning"
    - kubectl apply -f k8s/ingress/

    # ğŸ—„ï¸ Base de donnÃ©es
    - kubectl apply -f k8s/postgres/
    - kubectl wait --for=condition=available --timeout=300s deployment/postgres -n $NAMESPACE
    
    # ğŸ”‘ Authentification Keycloak
    - kubectl apply -f k8s/keycloak/keycloak-secret.yaml
    - kubectl apply -f k8s/keycloak/keycloak-service.yaml
    - ls -R k8s/keycloak/themes/mytheme
    - kubectl create configmap keycloak-theme --from-file=k8s/keycloak/themes/mytheme --namespace=annual-project --dry-run=client -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/keycloak/keycloak-all.yaml

    # ğŸ”§ Outils d'administration
    - kubectl apply -f k8s/adminer/
    - kubectl apply -f k8s/uptime-kuma/

    # ğŸ·ï¸ Mise Ã  jour des images avec SHA commit
    - FRONTEND_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/frontend:${CI_COMMIT_SHA}"
    - API_IMAGE="${AR_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPO}/api:${CI_COMMIT_SHA}"
    - sed -i "s|image europe-west1-docker.pkg.dev/.*/frontend:.*|image ${FRONTEND_IMAGE}|g" k8s/frontend/frontend-all.yaml
    - sed -i "s|image europe-west1-docker.pkg.dev/.*/api:.*|image $API_IMAGE|g" k8s/api/api-all.yaml

    # ğŸš€ DÃ©ploiement des applications
    - kubectl apply -f k8s/api/
    - kubectl wait --for=condition=available --timeout=300s deployment/api -n $NAMESPACE
    - kubectl apply -f k8s/frontend/
    - kubectl wait --for=condition=available --timeout=300s deployment/frontend -n $NAMESPACE

    # â³ Finalisation Keycloak
    - kubectl wait --for=condition=available --timeout=600s deployment/keycloak -n $NAMESPACE || echo "âš ï¸ Keycloak peut nÃ©cessiter plus de temps"
  tags:
    - ilyes-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"
  needs:
    - job: ğŸ—ï¸ build-frontend
    - job: ğŸ—ï¸ build-api
```

## ğŸ”„ Workflow GitFlow

### DÃ©veloppement Feature

```bash
# 1. CrÃ©er une branche feature
git checkout -b feature/nouvelle-fonctionnalite

# 2. DÃ©velopper et commiter
git add .
git commit -m "feat: nouvelle fonctionnalitÃ©"

# 3. Push dÃ©clenche les tests automatiquement
git push origin feature/nouvelle-fonctionnalite
# â†’ Pipeline: ğŸ§ª Tests Frontend + API uniquement
```

### IntÃ©gration Develop

```bash
# 1. Merge Request vers develop
# â†’ Pipeline: ğŸ§ª Tests Frontend + API

# 2. AprÃ¨s merge dans develop
git checkout develop
git pull origin develop
# â†’ Pipeline: ğŸ§ª Tests Frontend + API
```

### Release Production

```bash
# 1. Merge Request develop â†’ main
# â†’ Pipeline: ğŸ—ï¸ Build + ğŸš€ Deploy (pas de tests)

# 2. AprÃ¨s merge dans main
git checkout main
git pull origin main
# â†’ Pipeline: Build + Deploy uniquement
```

## ğŸ“¦ Services DÃ©ployÃ©s

### Stack Applicative

| Service | Image | Port | Description |
|---------|-------|------|-------------|
| **Frontend** | `{AR}/frontend:{SHA}` | 3000 | Interface React |
| **API** | `{AR}/api:{SHA}` | 5000 | Backend Node.js |
| **PostgreSQL** | `postgres:14` | 5432 | Base de donnÃ©es |
| **Keycloak** | `keycloak:latest` | 8080 | Authentification |

### Services Auxiliaires

| Service | Type | URL | Description |
|---------|------|-----|-------------|
| **Adminer** | DB Admin | `adminer.fitnessconnect.fr` | Interface PostgreSQL |
| **Uptime Kuma** | Monitoring | `uptimekuma.fitnessconnect.fr` | Surveillance services |

## ğŸŒ Configuration RÃ©seau & SÃ©curitÃ©

### Ingress & DNS

```yaml
# URLs de production
Frontend:   https://fitnessconnect.fr
API:        https://api.fitnessconnect.fr  
Keycloak:   https://login.fitnessconnect.fr
Adminer:    https://adminer.fitnessconnect.fr
Uptime:     https://uptimekuma.fitnessconnect.fr

# Certificat SSL managÃ©
ManagedCertificate: fitnessconnect-cert
```

### Network Policies

```yaml
# SÃ©curitÃ© au niveau namespace
- Isolation rÃ©seau inter-pods
- RÃ¨gles de communication strictes
- Protection DDoS et intrusions
```

## ğŸ¯ Avantages de la Nouvelle Pipeline

### âœ… Workflow GitFlow OptimisÃ©

- **Tests continus** sur les branches de dÃ©veloppement (feature + develop)
- **Build optimisÃ©** uniquement sur main (aprÃ¨s validation des tests)
- **DÃ©ploiement rapide** en production sans re-tester

### âœ… Optimisation des Ressources

- **Pas de tests redondants** sur main (dÃ©jÃ  validÃ©s sur develop)
- **Build direct** aprÃ¨s validation des tests
- **Runner dÃ©diÃ©** pour performances garanties
- **Cache intelligent** des dÃ©pendances Node.js

### âœ… SÃ©curitÃ© RenforcÃ©e

- **Images taggÃ©es** avec SHA commit pour traÃ§abilitÃ©
- **Authentification GCP** par service account
- **Secrets GitLab CI** pour credentials sensibles

### âœ… DÃ©ploiement Robuste

- **Attente synchronisÃ©e** des dÃ©ploiements K8s
- **Rollback automatique** en cas d'Ã©chec
- **Monitoring intÃ©grÃ©** avec Uptime Kuma

## ğŸ”§ Configuration Technique

### Runner Requirements

```yaml
Runner: ilyes-runner
Features:
  - Docker socket access (unix:///var/run/docker.sock)
  - Internet connectivity for GCP
  - Sufficient storage for images Docker
```

### Variables SecrÃ¨tes GitLab

```yaml
Required Secrets:
  - GCP_SERVICE_KEY: Service account GCP (base64)
  
Optional:
  - KEYCLOAK_DB_PASSWORD: Password Keycloak DB
  - POSTGRES_PASSWORD: Password PostgreSQL
```

### Images Registry

```bash
# Format des tags
Commit SHA: europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/{service}:{CI_COMMIT_SHA}
Latest:     europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/{service}:latest

# Exemples
Frontend: europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/frontend:abc123def
API:      europe-west1-docker.pkg.dev/k8s-frist-test/annual-project-repo/api:abc123def
```

## ğŸ“Š Monitoring & ObservabilitÃ©

### Outils IntÃ©grÃ©s

- **Uptime Kuma** : Surveillance temps rÃ©el des services
- **Adminer** : Interface d'administration PostgreSQL
- **GitLab CI** : Logs et mÃ©triques des pipelines
- **Google Cloud** : Monitoring infrastructure K8s

### MÃ©triques ClÃ©s

- **Temps de build** : ~5-10 minutes par composant
- **Temps de dÃ©ploiement** : ~15-20 minutes complet
- **DisponibilitÃ©** : Monitoring 24/7 via Uptime Kuma
- **Performances** : MÃ©triques GKE et Load Balancer

---